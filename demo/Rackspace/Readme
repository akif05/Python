======================
###### func.py #######
import requests
from bs4 import BeautifulSoup
import lxml.html as lh
import re
import sys
import configparser
import os.path

def get_request_url_data(url, username, password):

    try:
        r = requests.get(url, auth=(username, password))
    except:
        print(f"Error accessing {url}")
        sys.exit(3)
    
    if r.status_code != 200:
        print(f'Can not get to the URL {url}')
        sys.exit(4)
    
    ## Return r which is obtained from requests.
    return r
### end ########################################

def get_all_object_by_id(soup, obj_base_url):

    urls = []
    exlude_list = ["CableOrganizer", "Organizer", "spacer", "PDU", "Shelf", "PatchPanel"]

    div = soup.find("div", {"class":"portlet"})
    table = div.find("table")
    rows = table.find_all("tr", {"class": ["row_odd", "row_even"]})
    for row in rows:
        tmp = str(re.findall(r'<strong>(.*?)</strong>', str(row.find_all('strong'))))
        if any (x in tmp for x in exlude_list): 
            continue
        # Sometime returns two list of two value, extract the first one
        obj_id = re.findall(r'object_id=([0-9]*)">', str(row))
        obj_id = str(obj_id[0].strip("[]'"))
        # obj_id = str(re.findall(r'object_id=([0-9]*)">', str(row))).strip("[]'")
        url = """%s%s""" % (obj_base_url, obj_id)
        urls.append(url)

    # Return list of objects url with object id to retrive information for each object 
    return urls

### end ########################################
======================
###### get_config_data.py #######
import configparser
import os.path

def get_config_data (config_file):

    d = dict();
    config = configparser.ConfigParser()
    try:
        config.read(config_file)
    except:
        print(f"Reading file {config_file} problem.")
        sys.exit(2)

    d['passwd'] = config.get("myvars", "passwd");
    d['username'] = config.get("myvars", "username");
    d['url'] = config.get("myvars", "url");
    d['base_url'] = config.get("myvars", "base_url");
    
    return d
======================
###### get_objects_info.py #######
## Get table frm soup and extract the key value from html table
## format of row in table: 
#<tr>
# <th class="tdright sticker" width="50%">FQDN:</th>
# <td class="tdleft"><a  href="ssh://mail8.webfaction.com">mail8.webfaction.com</a></td>
#</tr>
# In <th> tag is the key and in <td> tag is the value we are using to create dictionary

def get_objects_info(beauty_soap):

    key_list = []
    value_list = []
    object_dict = {}
    line = "=" * 50

    div = beauty_soap.find("div", {"class":"portlet"})
    table = div.find("table")
    rows = table.find_all("tr")

    for row in rows:
        if hasattr(row.th, 'text'):
            key_list.append(str(row.th.text.strip().strip(":").replace(" ", "_")))
        else:
            key_list.append("No_key")

        if hasattr(row.td, 'text'):
            value_list.append(str(row.td.text.strip()))
        else:
            value_list.append("No_value")

    return dict(zip(key_list, value_list))


======================
###### is_object_in.py #######
def is_object_in(dict_obj, key, val):

    ## If is dictionary get the values for the key
    ## if the valie is not string return false
    if hasattr(dict_obj, 'get'):
        value = dict_obj.get(key)
        if isinstance(value, str) == False:
            return False
    else:
        return False
    
    ## Check if the value is list or string and is lookup string we
    ## Are looking for. If yes return True if not retrun False
    if val in value:
        return True
    else:
        return False
======================
###### main.py #######
import requests
from bs4 import BeautifulSoup
import lxml.html as lh
import re
import sys
import os
import  os.path
import configparser
import os.path
import time
from func import *
from get_objects_info import *
from is_object_in import *
from print_obj_dict import print_obj_dict
from get_config_data import get_config_data

def main():

    line = "=" * 50
    explisit_tag = "available stock"
   
    ## Check if file exist and is accessable!
    config_file = "/Users/akifyusein/.my_a_pass"
    if not (os.path.isfile(config_file) and os.access(config_file, os.R_OK)):
        print (f'File: {config_file} not found, or not accesable.')
        sys.exit(1)

    # Get dictionary with config variables for auth and urls
    d = get_config_data (config_file) 

    req = get_request_url_data(d['url'], d['username'], d['passwd'])
    soup = BeautifulSoup(req.text, 'lxml')

    # Create urls for all objects except PDU and cable organizer
    urls = get_all_object_by_id(soup, d['base_url'])
    soup = ""
    # From each url in list get data and find objects with explisit tag Shared cPanel
    i = 0
    for url in urls:
        i += 1
        if i > 10:
            sys.exit(3)
        
        try:
            req = get_request_url_data(url, d['username'], d['passwd'])
        except:
            print(f'Can not retrive: {url}')
            continue
        soup = BeautifulSoup(req.text, 'lxml')
        obj_dict = get_objects_info(soup)

        ## Get the key and lookup from command line!
        key = 'Explicit_tags'
        lookup = 'managed'
        # lookup = 'available stock'
        flag = is_object_in(obj_dict, key, lookup)

        if flag == True:
            # Get the object num form url and print out for user info.
            object_number = str(re.findall(r'object_id=([0-9]*)', url)).strip("[]'") 
            print_obj_dict(obj_dict, object_number)
        else:
            continue
 
if __name__ == '__main__':
    main()
======================
###### print_obj_dict.py #######
## Print each key value pair in dictionary!
def print_obj_dict(object_dict, obj_id):

    line = "=" * 50
    print(line)
    print(f'Object id: {obj_id}')
    
    if hasattr(object_dict, 'items'):    
        for key, val in object_dict.items():
            print(f'{key}: {val}')

